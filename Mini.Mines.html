<!DOCTYPE html>
<html lang="en">
<head>

  <link rel="icon" type="image/x-icon" href="favicon/favicon.ico" />

<meta charset="UTF-8">
<title>Mini Mines Game</title>
<style>
  body { margin:0; font-family:sans-serif; background:#222; color:#fff; display:flex; flex-direction:column; align-items:center; height:100vh; }
  #header {
    width: 400px;
    display:flex; justify-content:space-between; align-items:center; padding:10px; color:white;
    font-family: 'Arial Black', sans-serif;
  }
  #logo { font-size:24px; font-weight:bold; color: #ffcc00; text-shadow: 2px 2px 5px #000; transition: transform 0.25s ease; }
  #logo.win-anim { animation: pulse 1.2s ease-in-out 3; }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.12); }
    100% { transform: scale(1); }
  }
  #timer, #minesCount { font-size:18px; }
  canvas { background: #333; display:block; opacity:1; margin-top:10px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
  #overlay {
    position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(34,34,34,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; color:white; z-index:50;
  }
  #restartBtn { margin-top:10px; padding:10px 20px; font-size:18px; cursor:pointer; display:none; position:absolute; top:10px; right:10px; z-index:60; }
  #countdown { font-size: 40px; margin-top: 20px; }
  #winBox { position: fixed; top:20%; left:50%; transform:translateX(-50%); background: rgba(0,0,0,0.8); padding:20px 30px; border-radius:10px; display:none; z-index:70; text-align:center; box-shadow:0 6px 30px rgba(0,0,0,0.7); }
  #winBox h2 { margin:0 0 10px 0; color:#ffb347; }
  /* small legend for flags */
  #legend { width:400px; display:flex; justify-content:center; gap:10px; margin-top:6px; font-size:13px; color:#ddd; }
  .legend-item { display:flex; align-items:center; gap:6px; }
  .flag-box { width:14px; height:14px; background:darkgray; border-radius:2px; display:inline-block; }
</style>
</head>
<body>

<div id="header">
  <div id="timer">Time: 0s</div>
  <div id="logo">Mini Mines</div>
  <div id="minesCount">Mines: 0</div>
</div>
<div id="legend"><div class="legend-item"><span class="flag-box"></span> Flag = safe</div></div>

<div id="overlay">
  <h1>Mini Mines Game</h1>
  <p>Goal: Open all tiles without hitting bombs or getting caught by the monster.</p>
  <p>How to play:</p>
  <ul>
    <li>Arrow keys to move</li>
    <li>Tiles show color only after opening: Gray 0, Blue 1, Yellow 2, Red 3</li>
    <li>Every 10 opened tiles, a monster appears</li>
    <li>Monster moves once every 5 seconds</li>
    <li>Press "E" to kill a monster if you have enough energy (1 energy per 20 opened tiles)</li>
    <li>Press "F" + W/A/S/D to place a safe flag on adjacent tile</li>
    <li>Press "G" + W/A/S/D to remove a flag on adjacent tile</li>
  </ul>
  <p>The game will start automatically:</p>
  <div id="countdown">15</div>
</div>

<button id="restartBtn">Restart</button>
<canvas id="game" width="400" height="400"></canvas>

<div id="winBox">
  <h2>You Win!</h2>
  <p>All safe tiles opened — nice job!</p>
  <button id="winRestart">Restart</button>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const timerElem = document.getElementById('timer');
const minesElem = document.getElementById('minesCount');
const logoElem = document.getElementById('logo');
const winBox = document.getElementById('winBox');
const winRestart = document.getElementById('winRestart');

const TILE_SIZE = 40;
const ROWS = 10;
const COLS = 10;
let TOTAL_MINES = 15;

let tiles = [];
let player = {x:0, y:0};
let monsters = [];
let openCount = 0;
let gameOver = false;
let killEnergy = 0;
let deathTile = null;
let placingFlag = false;
let removingFlag = false;
let elapsedTime = 0;
let timerInterval;

// --- Инициализация игры ---
function initGame() {
  tiles = [];
  player = {x:0, y:0};
  monsters = [];
  openCount = 0;
  gameOver = false;
  killEnergy = 0;
  deathTile = null;
  placingFlag = false;
  removingFlag = false;
  elapsedTime = 0;

  // таймер
  clearInterval(timerInterval);
  timerInterval = setInterval(()=> {
    elapsedTime++;
    timerElem.textContent = "Time: "+elapsedTime+"s";
  },1000);

  for(let y=0; y<ROWS; y++){
    tiles[y] = [];
    for(let x=0; x<COLS; x++){
      tiles[y][x] = {bomb:false, open:false, wall:false, color:null, count:0, safeFlag:false};
    }
  }

  // стартовые координаты (5)
  const safeCoords = [[0,0],[1,0],[0,1],[1,1],[0,2]];

  // Расставляем мины, избегая стартовых плиток и их окружения
  let minesPlaced = 0;
  while(minesPlaced<TOTAL_MINES){
    let rx = Math.floor(Math.random()*COLS);
    let ry = Math.floor(Math.random()*ROWS);
    if(!tiles[ry][rx].bomb && !safeCoords.some(([sx,sy])=>sx===rx && sy===ry)){
      // не ставим мину прямо рядом со стартовой зоной (чтобы серые были действительно безопасны)
      const nearStart = safeCoords.some(([sx,sy])=>Math.abs(sx-rx)<=1 && Math.abs(sy-ry)<=1);
      if(nearStart) continue;
      tiles[ry][rx].bomb = true;
      minesPlaced++;
    }
  }

  // Подсчет мин вокруг каждой плитки
  for(let y=0; y<ROWS; y++){
    for(let x=0; x<COLS; x++){
      let count = 0;
      for(let dy=-1; dy<=1; dy++){
        for(let dx=-1; dx<=1; dx++){
          if(dx===0 && dy===0) continue;
          const nx = x+dx, ny = y+dy;
          if(nx>=0 && nx<COLS && ny>=0 && ny<ROWS && tiles[ny][nx].bomb) count++;
        }
      }
      tiles[y][x].count = count;
      if(count===0) tiles[y][x].color='gray';
      else if(count===1) tiles[y][x].color='blue';
      else if(count===2) tiles[y][x].color='yellow';
      else tiles[y][x].color='red';
    }
  }

  // Открываем стартовые 5 плиток (они серые)
  for(let i=0;i<safeCoords.length;i++){
    const [sx,sy] = safeCoords[i];
    tiles[sy][sx].open = true;
    tiles[sy][sx].color = 'gray';
    openCount++;
  }

  minesElem.textContent = "Mines: "+TOTAL_MINES;
  document.getElementById('restartBtn').style.display = 'none';
  winBox.style.display = 'none';
  logoElem.classList.remove('win-anim');
}

// --- Проверка выигрыша ---
function checkWin(){
  // если все не-бомбовые плитки открыты -> победа
  let allSafeOpened = true;
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const t = tiles[y][x];
      if(!t.bomb && !t.open){
        allSafeOpened = false;
        break;
      }
    }
    if(!allSafeOpened) break;
  }

  if(allSafeOpened){
    handleWin();
  }
}

// --- Обработка победы ---
function handleWin(){
  gameOver = true;

  // Показать все мины оранжевым, даже под флагами
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(tiles[y][x].bomb){
        tiles[y][x].open = true;
        tiles[y][x].color = 'orange';
      }
    }
  }

  // Анимация логотипа (пульсация)
  logoElem.classList.add('win-anim');

  // Небольшая задержка, затем показать окно победы и кнопку рестарт
  setTimeout(()=>{
    winBox.style.display = 'block';
    document.getElementById('restartBtn').style.display = 'block';
  }, 900);
}

// --- Открытие плитки ---
function openTile(x,y){
  const t = tiles[y][x];
  if(t.open || t.wall || t.safeFlag) return;
  t.open = true;
  openCount++;
  if(t.bomb){
    gameOver = true;
    deathTile = {x,y};
    // показ всех мин при поражении (оранжевым)
    for(let yy=0; yy<ROWS; yy++){
      for(let xx=0; xx<COLS; xx++){
        if(tiles[yy][xx].bomb){
          tiles[yy][xx].open = true;
          tiles[yy][xx].color = 'orange';
        }
      }
    }
    document.getElementById('restartBtn').style.display = 'block';
    return;
  }

  if(openCount % 10 === 0) spawnMonster();
  if(openCount % 20 === 0) killEnergy++;

  checkWin();
}

// --- Спавн монстра ---
function spawnMonster(){ monsters.push({x:COLS-1, y:ROWS-1}); }

// --- Движение монстра каждые 5 секунд ---
setInterval(()=>{
  if(gameOver) return;
  monsters.forEach(monster=>{
    let dx = player.x - monster.x;
    let dy = player.y - monster.y;
    if(Math.abs(dx) > Math.abs(dy)){
      let nx = monster.x + Math.sign(dx);
      if(nx>=0 && nx<COLS && !tiles[monster.y][nx].wall) monster.x = nx;
    } else {
      let ny = monster.y + Math.sign(dy);
      if(ny>=0 && ny<ROWS && !tiles[ny][monster.x].wall) monster.y = ny;
    }
    if(monster.x===player.x && monster.y===player.y){
      gameOver = true;
      // показать все мины при смерти
      for(let yy=0; yy<ROWS; yy++){
        for(let xx=0; xx<COLS; xx++){
          if(tiles[yy][xx].bomb){
            tiles[yy][xx].open = true;
            tiles[yy][xx].color = 'orange';
          }
        }
      }
      document.getElementById('restartBtn').style.display='block';
    }
  });
},5000);

// --- Рисуем поле ---
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0; y<ROWS; y++){
    for(let x=0; x<COLS; x++){
      let t = tiles[y][x];
      let color = t.open ? t.color : 'black';
      if(t.wall) color='#555';
      if(deathTile && x===deathTile.x && y===deathTile.y) color='orange';
      if(t.safeFlag && !t.open) color='darkgray'; // визуализация флага
      ctx.fillStyle=color;
      ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE-2, TILE_SIZE-2);

      // optional: small flag icon
      if(t.safeFlag && !t.open){
        ctx.fillStyle = '#222';
        ctx.fillRect(x*TILE_SIZE+12, y*TILE_SIZE+8, 6, 12);
        ctx.fillStyle = '#ff4444';
        ctx.fillRect(x*TILE_SIZE+16, y*TILE_SIZE+8, 10, 6);
      }
    }
  }

  // игрок
  ctx.fillStyle='purple';
  ctx.fillRect(player.x*TILE_SIZE+5, player.y*TILE_SIZE+5, TILE_SIZE-10, TILE_SIZE-10);

  // монстры
  ctx.fillStyle='green';
  monsters.forEach(monster=>{
    ctx.fillRect(monster.x*TILE_SIZE+5, monster.y*TILE_SIZE+5, TILE_SIZE-10, TILE_SIZE-10);
  });

  requestAnimationFrame(draw);
}

// --- Управление игроком + F/G + E ---
document.addEventListener('keydown', e=>{
  if(gameOver) return;

  // F - включаем режим установки флага
  if(e.key.toLowerCase() === 'f'){ placingFlag = true; return; }

  // если ставим флаг - направление WASD
  if(placingFlag){
    let fx = player.x;
    let fy = player.y;
    const k = e.key.toLowerCase();
    if(k === 'w') fy--;
    else if(k === 's') fy++;
    else if(k === 'a') fx--;
    else if(k === 'd') fx++;
    else return;

    if(fx>=0 && fx < COLS && fy>=0 && fy<ROWS){
      let t = tiles[fy][fx];
      if(!t.open && !t.wall) t.safeFlag = true;
    }
    placingFlag = false;
    return;
  }

  // G - включаем режим снятия флага
  if(e.key.toLowerCase() === 'g'){ removingFlag = true; return; }

  if(removingFlag){
    let fx = player.x;
    let fy = player.y;
    const k = e.key.toLowerCase();
    if(k === 'w') fy--;
    else if(k === 's') fy++;
    else if(k === 'a') fx--;
    else if(k === 'd') fx++;
    else return;

    if(fx>=0 && fx < COLS && fy>=0 && fy<ROWS){
      tiles[fy][fx].safeFlag = false;
    }
    removingFlag = false;
    return;
  }

  // Движение игрока по стрелкам
  let nx = player.x;
  let ny = player.y;
  if(e.key === 'ArrowUp') ny--;
  if(e.key === 'ArrowDown') ny++;
  if(e.key === 'ArrowLeft') nx--;
  if(e.key === 'ArrowRight') nx++;

  if(nx>=0 && nx<COLS && ny>=0 && ny<ROWS && !tiles[ny][nx].wall){
    // если цель содержала флаг — флаг блокирует открытие/смерть (игрок может встать, но плитка не откроется)
    player.x = nx;
    player.y = ny;
    if(tiles[ny][nx].safeFlag){
      // флаг блокирует открытие — ничего не делаем (оставляем плитку закрытой)
    } else {
      openTile(nx, ny);
    }
  }

  // E - убить монстра если есть энергия
  if(e.key.toLowerCase() === 'e'){
    if(killEnergy>0 && monsters.length>0){
      monsters.pop();
      killEnergy--;
    }
  }
});

// --- Рестарт ---
document.getElementById('restartBtn').addEventListener('click', ()=>{
  initGame();
  draw();
});

// кнопка рестарта в окне победы
winRestart.addEventListener('click', ()=>{
  winBox.style.display = 'none';
  initGame();
  draw();
});

// --- Отсчёт перед игрой ---
let countdownNum=15;
const countdownElem=document.getElementById('countdown');
const countdownInterval=setInterval(()=>{
  countdownElem.textContent = countdownNum;
  countdownNum--;
  if(countdownNum<0){
    clearInterval(countdownInterval);
    document.getElementById('overlay').style.opacity=0;
    setTimeout(()=>{
      document.getElementById('overlay').style.display='none';
      canvas.style.opacity=1;
      initGame();
      draw();
    },1000);
  }
},1000);
</script>
</body>
</html>
